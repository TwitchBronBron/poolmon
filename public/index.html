<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Temperature Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .period-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: nowrap;
        }

        .current-period {
            font-weight: 600;
            color: #333;
            min-width: 150px;
            text-align: center;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .temperature-display {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }

        .temperature-unit {
            font-size: 0.6em;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .period-buttons {
            display: flex;
            gap: 5px;
            background: white;
            border-radius: 25px;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .period-btn {
            background: transparent;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            color: #666;
            white-space: nowrap;
        }

        .period-btn.active {
            background: #667eea;
            color: white;
        }

        .period-btn:hover:not(.active) {
            background: #f0f0f0;
        }

        .nav-btn {
            background: white;
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: #667eea;
            font-size: 1.1em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .nav-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            height: 400px;
        }

        .readings-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .readings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            user-select: none;
        }

        .readings-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapse-icon {
            transition: transform 0.3s ease;
            font-size: 1.2em;
            color: #667eea;
        }

        .collapse-icon.expanded {
            transform: rotate(90deg);
        }

        .readings-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .readings-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .readings-content.expanded {
            max-height: 1000px;
            opacity: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .refresh-btn {
            float: right;
            margin-bottom: 15px;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #5a67d8;
        }

        .timestamp {
            color: #666;
            font-size: 0.9em;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background: #f8f9ff !important;
        }

        /* Color utility classes */
        .pool-color {
            color: #667eea;
        }

        .outside-color {
            color: #f39c12;
        }

        .pool-bg {
            background-color: #667eea;
        }

        .outside-bg {
            background-color: #f39c12;
        }

        .text-muted {
            color: #ccc;
        }

        .text-gray {
            color: #666;
        }

        .pool-temp-display {
            color: #667eea;
        }

        .outside-temp-display {
            color: #f39c12;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 10px;
                border-radius: 15px;
            }

            h1 {
                font-size: 2em;
            }

            .temperature-display {
                font-size: 2.5em;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .dashboard-top {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .period-controls {
                gap: 8px;
            }

            .period-btn {
                padding: 6px 12px;
                font-size: 0.8em;
            }

            .nav-btn {
                width: 35px;
                height: 35px;
                font-size: 1em;
            }

            .card {
                padding: 15px;
            }

            .chart-container {
                padding: 15px;
            }

            .readings-table {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .stat-item {
                padding: 10px 5px;
            }

            .stat-value {
                font-size: 1em;
            }

            .stat-label {
                font-size: 0.8em;
            }

            .card h3 + div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
                gap: 20px !important;
            }

            .card:first-of-type h3 + div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }

            .temperature-display {
                font-size: 2em !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèä‚Äç‚ôÇÔ∏è Pool Temperature Monitor</h1>

        <div class="dashboard-top">
            <div class="card">
                <h3>Current Temperatures</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="text-align: center;">
                        <div class="temperature-display pool-temp-display" id="poolTemp">
                            --<span class="temperature-unit">¬∞F</span>
                        </div>
                        <div class="pool-color" style="font-weight: 600;">Pool</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="temperature-display outside-temp-display" id="outsideTemp">
                            --<span class="temperature-unit">¬∞F</span>
                        </div>
                        <div class="outside-color" style="font-weight: 600;">Outside</div>
                    </div>
                </div>
            </div>

            <div class="card stats-card">
                <h3>Stats</h3>
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="pool-bg" style="width: 20px; height: 3px; border-radius: 2px;"></div>
                        <span class="pool-color" style="font-weight: 600;">Pool</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="outside-bg" style="width: 20px; height: 3px; border-radius: 2px;"></div>
                        <span class="outside-color" style="font-weight: 600;">Outside</span>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div class="stat-value pool-color" id="poolAvgTemp">--</div>
                            <div class="stat-value outside-color" id="outsideAvgTemp">--</div>
                        </div>
                        <div class="stat-label">Average</div>
                    </div>
                    <div class="stat-item">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div class="stat-value pool-color" id="poolMinTemp">--</div>
                            <div class="stat-value outside-color" id="outsideMinTemp">--</div>
                        </div>
                        <div class="stat-label">Minimum</div>
                    </div>
                    <div class="stat-item">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div class="stat-value pool-color" id="poolMaxTemp">--</div>
                            <div class="stat-value outside-color" id="outsideMaxTemp">--</div>
                        </div>
                        <div class="stat-label">Maximum</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="period-controls">
            <button class="nav-btn" id="prevBtn">‚Äπ</button>

            <div class="period-buttons">
                <button class="period-btn active" data-period="hourly">Hourly</button>
                <button class="period-btn" data-period="day">Day</button>
                <button class="period-btn" data-period="week">Week</button>
                <button class="period-btn" data-period="month">Month</button>
                <button class="period-btn" data-period="year">Year</button>
            </div>

            <button class="nav-btn" id="nextBtn">‚Ä∫</button>
        </div>

        <div class="current-period" id="currentPeriod">This Hour</div>

        <div class="chart-container">
            <h3>Temperature Chart</h3>
            <canvas id="temperatureChart"></canvas>
        </div>

        <div class="readings-table">
            <div class="readings-header" onclick="toggleReadings()">
                <h3>
                    <span class="collapse-icon">‚ñ∂</span>
                    Recent Readings
                </h3>
                <button class="refresh-btn" onclick="event.stopPropagation(); loadReadingsTable()" style="display: none;" id="readingsRefreshBtn">Refresh</button>
            </div>
            <div class="readings-content collapsed" id="readingsContent">
                <table id="readingsTable">
                    <thead>
                        <tr>
                            <th>Pool Temp</th>
                            <th>Outside Temp</th>
                            <th>Date & Time</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let temperatureChart;
        let currentPeriod = 'hourly';
        let currentOffset = 0; // 0 = current, -1 = previous, 1 = next
        let readingsExpanded = false; // Track if readings table is expanded

        // Toggle readings table visibility
        function toggleReadings() {
            const content = document.getElementById('readingsContent');
            const icon = document.querySelector('.collapse-icon');
            const refreshBtn = document.getElementById('readingsRefreshBtn');

            readingsExpanded = !readingsExpanded;

            if (readingsExpanded) {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                icon.classList.add('expanded');
                refreshBtn.style.display = 'block';
                // Load readings table content when expanded
                loadReadingsTable();
            } else {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                icon.classList.remove('expanded');
                refreshBtn.style.display = 'none';
            }
        }

        // Load readings table data (separate from main loadData function)
        async function loadReadingsTable() {
            const periodParam = `?period=${currentPeriod}&offset=${currentOffset}`;

            try {
                // Load recent readings for selected period
                const readingsUrl = `/api/temperatures${periodParam}&limit=20`;
                const readingsResponse = await fetch(readingsUrl);
                const readings = await readingsResponse.json();

                const tbody = document.querySelector('#readingsTable tbody');
                tbody.innerHTML = '';

                // Group readings by timestamp for hourly view
                if (currentPeriod === 'hourly') {
                    const groupedReadings = {};
                    readings.forEach(reading => {
                        if (!groupedReadings[reading.timestamp]) {
                            groupedReadings[reading.timestamp] = {};
                        }
                        groupedReadings[reading.timestamp][reading.location] = reading;
                    });

                    // Sort timestamps in descending order (most recent first)
                    const sortedTimestamps = Object.keys(groupedReadings).sort((a, b) => new Date(b) - new Date(a));

                    sortedTimestamps.forEach(timestamp => {
                        const group = groupedReadings[timestamp];
                        const poolReading = group.pool;
                        const outsideReading = group.outside;

                        const row = tbody.insertRow();
                        row.className = 'clickable-row';
                        row.style.cursor = 'pointer';

                        // Navigate to more detailed view when clicked
                        row.onclick = () => {
                            const readingDate = new Date(timestamp);
                            const now = new Date();

                            if (currentPeriod === 'day') {
                                // Day -> Hourly: Calculate hour offset
                                currentPeriod = 'hourly';
                                const readingHour = new Date(readingDate.getFullYear(), readingDate.getMonth(), readingDate.getDate(), readingDate.getHours());
                                const nowHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
                                currentOffset = Math.round((readingHour - nowHour) / (1000 * 60 * 60));
                            }

                            // Update active button
                            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
                            const activeBtn = document.querySelector(`[data-period="${currentPeriod}"]`);
                            if (activeBtn) activeBtn.classList.add('active');

                            loadData();
                        };

                        const poolTemp = poolReading ? `<strong class="pool-color">${poolReading.temperature.toFixed(1)}¬∞F</strong>` : '<span class="text-muted">N/A</span>';
                        const outsideTemp = outsideReading ? `<strong class="outside-color">${outsideReading.temperature.toFixed(1)}¬∞F</strong>` : '<span class="text-muted">N/A</span>';

                        row.innerHTML = `
                            <td>${poolTemp}</td>
                            <td>${outsideTemp}</td>
                            <td>${new Date(timestamp).toLocaleString('en-US', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit',
                                second: '2-digit',
                                hour12: true
                            })}</td>
                        `;
                    });
                } else {
                    // For non-hourly views, use the original single-row format
                    readings.forEach(reading => {
                        const row = tbody.insertRow();
                        const tempColorClass = reading.location === 'pool' ? 'pool-color' : 'outside-color';
                        const isAverage = reading.reading_count && reading.reading_count > 1;
                        const avgIndicator = isAverage ? ` <span class="text-gray" style="font-size: 0.8em;">(avg of ${reading.reading_count} readings)</span>` : '';

                        row.className = 'clickable-row';
                        row.style.cursor = 'pointer';

                        // Navigate to more detailed view when clicked
                        row.onclick = () => {
                            const readingDate = new Date(reading.timestamp);
                            const now = new Date();

                            if (currentPeriod === 'year') {
                                // Year -> Month: Calculate month offset
                                currentPeriod = 'month';
                                const yearDiff = readingDate.getFullYear() - now.getFullYear();
                                const monthDiff = readingDate.getMonth() - now.getMonth();
                                currentOffset = yearDiff * 12 + monthDiff;
                            } else if (currentPeriod === 'month' || currentPeriod === 'week') {
                                // Month/Week -> Day: Calculate day offset
                                currentPeriod = 'day';
                                const readingDay = new Date(readingDate.getFullYear(), readingDate.getMonth(), readingDate.getDate());
                                const nowDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                                currentOffset = Math.round((readingDay - nowDay) / (1000 * 60 * 60 * 24));
                            } else if (currentPeriod === 'day') {
                                // Day -> Hourly: Calculate hour offset
                                currentPeriod = 'hourly';
                                const readingHour = new Date(readingDate.getFullYear(), readingDate.getMonth(), readingDate.getDate(), readingDate.getHours());
                                const nowHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours());
                                currentOffset = Math.round((readingHour - nowHour) / (1000 * 60 * 60));
                            }

                            // Update active button
                            document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
                            const activeBtn = document.querySelector(`[data-period="${currentPeriod}"]`);
                            if (activeBtn) activeBtn.classList.add('active');

                            loadData();
                        };

                        // For non-hourly views, show in separate columns but maintain original location-based format
                        if (reading.location === 'pool') {
                            row.innerHTML = `
                                <td><strong class="${tempColorClass}">${reading.temperature.toFixed(1)}¬∞F</strong>${avgIndicator}</td>
                                <td><span class="text-muted">--</span></td>
                                <td>${new Date(reading.timestamp).toLocaleString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: 'numeric',
                                    minute: '2-digit',
                                    second: currentPeriod === 'hourly' ? '2-digit' : undefined,
                                    hour12: true
                                })}</td>
                            `;
                        } else {
                            row.innerHTML = `
                                <td><span class="text-muted">--</span></td>
                                <td><strong class="${tempColorClass}">${reading.temperature.toFixed(1)}¬∞F</strong>${avgIndicator}</td>
                                <td>${new Date(reading.timestamp).toLocaleString('en-US', {
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric',
                                    hour: 'numeric',
                                    minute: '2-digit',
                                    second: currentPeriod === 'hourly' ? '2-digit' : undefined,
                                    hour12: true
                                })}</td>
                            `;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading readings table:', error);
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();

            // Set up event listeners
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active button
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    currentPeriod = this.dataset.period;
                    currentOffset = 0; // Reset to current when changing period
                    loadData();
                });
            });

            document.getElementById('prevBtn').addEventListener('click', function() {
                currentOffset--;
                loadData();
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                currentOffset++;
                loadData();
            });

            // Auto-refresh every 30 seconds (only for current period)
            setInterval(() => {
                if (currentOffset === 0) loadData();
            }, 30000);
        });

        function getPeriodLabel() {
            const now = new Date();
            let targetDate = new Date(now);

            switch (currentPeriod) {
                case 'hourly':
                    targetDate.setHours(now.getHours() + currentOffset);
                    const hourName = targetDate.toLocaleString('en-US', {
                        weekday: 'long',
                        month: 'long',
                        day: 'numeric',
                        hour: 'numeric',
                        hour12: true
                    });

                    if (currentOffset === 0) return `${hourName} (now)`;
                    return hourName;

                case 'day':
                    targetDate.setDate(now.getDate() + currentOffset);
                    const dayName = targetDate.toLocaleDateString('en-US', { weekday: 'long' });
                    const monthDay = targetDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

                    if (currentOffset === 0) return `${dayName} ${monthDay} (today)`;
                    if (currentOffset === -1) return `${dayName} ${monthDay} (yesterday)`;
                    return `${dayName} ${monthDay}`;

                case 'week':
                    targetDate.setDate(now.getDate() + (currentOffset * 7));
                    const weekText = `Week of ${targetDate.toLocaleDateString()}`;
                    if (currentOffset === 0) return `${weekText} (this week)`;
                    if (currentOffset === -1) return `${weekText} (last week)`;
                    return weekText;

                case 'month':
                    targetDate.setMonth(now.getMonth() + currentOffset);
                    const monthText = targetDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    if (currentOffset === 0) return `${monthText} (this month)`;
                    if (currentOffset === -1) return `${monthText} (last month)`;
                    return monthText;

                case 'year':
                    targetDate.setFullYear(now.getFullYear() + currentOffset);
                    const yearText = targetDate.getFullYear().toString();
                    if (currentOffset === 0) return `${yearText} (this year)`;
                    if (currentOffset === -1) return `${yearText} (last year)`;
                    return yearText;

                default:
                    return 'Current Period';
            }
        }

        async function loadData() {
            document.getElementById('currentPeriod').textContent = getPeriodLabel();

            const periodParam = `?period=${currentPeriod}&offset=${currentOffset}`;

            try {
                // Load latest temperatures for both locations (always current)
                const poolResponse = await fetch('/api/temperatures/latest?location=pool');
                const poolData = await poolResponse.json();

                const outsideResponse = await fetch('/api/temperatures/latest?location=outside');
                const outsideData = await outsideResponse.json();

                document.getElementById('poolTemp').innerHTML =
                    poolData.temperature ? `${poolData.temperature.toFixed(1)}<span class="temperature-unit">¬∞F</span>` : '--<span class="temperature-unit">¬∞F</span>';

                document.getElementById('outsideTemp').innerHTML =
                    outsideData.temperature ? `${outsideData.temperature.toFixed(1)}<span class="temperature-unit">¬∞F</span>` : '--<span class="temperature-unit">¬∞F</span>';

                // Update chart first (higher priority)
                await updateChart();

                // Only load readings table if it's currently expanded
                if (readingsExpanded) {
                    loadReadingsTable();
                }

                // Load statistics for selected period (lower priority, load after chart)
                const poolStatsResponse = await fetch(`/api/temperatures/stats${periodParam}&location=pool`);
                const poolStats = await poolStatsResponse.json();

                const outsideStatsResponse = await fetch(`/api/temperatures/stats${periodParam}&location=outside`);
                const outsideStats = await outsideStatsResponse.json();

                document.getElementById('poolAvgTemp').textContent = poolStats.avg_temp ? poolStats.avg_temp.toFixed(1) + '¬∞F' : '--';
                document.getElementById('poolMinTemp').textContent = poolStats.min_temp ? poolStats.min_temp.toFixed(1) + '¬∞F' : '--';
                document.getElementById('poolMaxTemp').textContent = poolStats.max_temp ? poolStats.max_temp.toFixed(1) + '¬∞F' : '--';

                document.getElementById('outsideAvgTemp').textContent = outsideStats.avg_temp ? outsideStats.avg_temp.toFixed(1) + '¬∞F' : '--';
                document.getElementById('outsideMinTemp').textContent = outsideStats.min_temp ? outsideStats.min_temp.toFixed(1) + '¬∞F' : '--';
                document.getElementById('outsideMaxTemp').textContent = outsideStats.max_temp ? outsideStats.max_temp.toFixed(1) + '¬∞F' : '--';

            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function updateChart() {
            const ctx = document.getElementById('temperatureChart').getContext('2d');

            if (temperatureChart) {
                temperatureChart.destroy();
            }

            // Fetch aggregated data for the selected period and offset
            const response = await fetch(`/api/temperatures?period=${currentPeriod}&offset=${currentOffset}`);
            const data = await response.json();

            // Separate data by location
            const poolData = data.filter(d => d.location === 'pool');
            const outsideData = data.filter(d => d.location === 'outside');

            // Create time labels (use the first dataset for timestamps)
            const allTimestamps = [...new Set(data.map(d => d.timestamp))].sort();
            const labels = allTimestamps.map(t => {
                const date = new Date(t);
                switch (currentPeriod) {
                    case 'hourly':
                        return date.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        });
                    case 'day':
                        const hours = date.getHours();
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        const displayHours = hours % 12 || 12;
                        return `${displayHours}:00 ${ampm}`;
                    case 'week':
                    case 'month':
                        return date.toLocaleDateString();
                    case 'year':
                        return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    default:
                        return date.toLocaleTimeString();
                }
            });

            // Map temperatures to timestamps
            const poolTemps = allTimestamps.map(timestamp => {
                const reading = poolData.find(d => d.timestamp === timestamp);
                return reading ? reading.temperature : null;
            });

            const outsideTemps = allTimestamps.map(timestamp => {
                const reading = outsideData.find(d => d.timestamp === timestamp);
                return reading ? reading.temperature : null;
            });

            temperatureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pool Temperature (¬∞F)',
                        data: poolTemps,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        spanGaps: true
                    }, {
                        label: 'Outside Temperature (¬∞F)',
                        data: outsideTemps,
                        borderColor: '#f39c12',
                        backgroundColor: 'rgba(243, 156, 18, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        pointBackgroundColor: '#f39c12',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1) + '¬∞F';
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverRadius: 8
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
